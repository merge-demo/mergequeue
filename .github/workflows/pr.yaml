name: PR Testing
run-name: PR Checks for ${{ github.ref_name }}
on:
  pull_request: {}
  push:
    branches:
      - trunk-merge/**

# Concurrency group so we can detect duplicate runs (pull_request + push for same branch).
# We do not cancel in progress - the duplicate run will skip so MQ doesn't see a failure.
concurrency:
  group: pr-test-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: false

jobs:
  test:
    name: run tests to validate pr
    runs-on: ubuntu-slim
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # If another run of this workflow is already in progress for this branch, skip (we're the duplicate)
      - name: Check for duplicate run
        id: duplicate
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.BRANCH_NAME;
            const runId = context.runId;
            const { data: currentRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            const workflowId = currentRun.workflow_id;
            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'in_progress',
              branch: branch,
              per_page: 20
            });
            const sameWorkflow = workflow_runs.filter(r => r.workflow_id === workflowId);
            const ids = sameWorkflow.map(r => r.id);
            const minId = Math.min(...ids);
            const skipDuplicate = runId !== minId;
            core.setOutput('skip_duplicate', skipDuplicate);
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

      - uses: robinraju/release-downloader@v1.9
        if: steps.duplicate.outputs.skip_duplicate != 'true'
        with:
          repository: trunk-io/mergequeue-tool
          latest: true
          tarBall: true
          preRelease: false
          extract: true

      - name: Make mq executable
        if: steps.duplicate.outputs.skip_duplicate != 'true'
        run: chmod +x ./mq

      - name: Determine is_merge
        id: check_is_merge
        if: steps.duplicate.outputs.skip_duplicate != 'true'
        run: |
          if [[ ${GITHUB_EVENT_NAME} == "push" && (${GITHUB_REF_NAME} == trunk-merge/* || ${GITHUB_REF_NAME} == trunk-merge-beta/*) || "${{ github.event.pull_request.title }}" == trunk-merge/*  ]]; then            
            echo "on_merge=true" >> $GITHUB_OUTPUT
          else
          echo "on_merge=false" >> $GITHUB_OUTPUT
          fi

      - name: run tests
        id: test
        # only actually run the test if we're on the merge branch
        # so we can simulate delay and flakiness
        if:
          steps.duplicate.outputs.skip_duplicate != 'true' && steps.check_is_merge.outputs.on_merge
          == 'true'
        run: |
          ./mq test-sim
        env:
          IS_MERGE: ${{ steps.check_is_merge.outputs.on_merge }}
